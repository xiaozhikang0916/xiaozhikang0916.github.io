<!DOCTYPE html><html lang="[&quot;zh-CN&quot;,&quot;en&quot;,&quot;default&quot;]"><head><meta name="referrer" content="no-referrer"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Android 使用Powermock的单元测试的 Rule 顺序 | Xiao's Blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-143241641-1','auto');ga('send','pageview');
</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.4.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Android 使用Powermock的单元测试的 Rule 顺序</h1><a id="logo" href="/.">Xiao's Blog</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Android 使用Powermock的单元测试的 Rule 顺序</h1><div class="post-meta">2019-12-10</div><div class="post-content"><p>在使用 <a target="_blank" rel="noopener" href="https://github.com/powermock/powermock">Powermock</a> 进行安卓的单元测试的编写时，出现了一些已经被调用了初始化的业务代码在执行测试时没有被初始化的情况，在此记录一下解决问题的过程。</p>
<h2 id="初始项目"><a href="#初始项目" class="headerlink" title="初始项目"></a>初始项目</h2><p>首先建立一个类 <code>InitData</code> ，代表需要被初始化的业务单例代码：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> InitData &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> initData: <span class="built_in">Int</span> = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">init</span><span class="params">(<span class="keyword">init</span>: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">        initData = <span class="keyword">init</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getData</span><span class="params">()</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> initData</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后建立一个测试，需要在测试开始前对这个单例进行初始化，然后验证传入的值：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(AndroidJUnit4::class)</span></span><br><span class="line"><span class="meta">@Config(sdk = [26])</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BeforeTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Rule</span></span><br><span class="line">    <span class="meta">@JvmField</span></span><br><span class="line">    <span class="keyword">val</span> powerMockRule = PowerMockRule()</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">        InitData.<span class="keyword">init</span>(<span class="number">10</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">testInit</span><span class="params">()</span></span> &#123;</span><br><span class="line">        assertEquals(<span class="number">10</span>, InitData.getData())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="测试优化"><a href="#测试优化" class="headerlink" title="测试优化"></a>测试优化</h2><p>像上面的代码能正常运行通过，但是：</p>
<ol>
<li>大部分的初始化操作都很类似，容易出现代码复制粘贴的情况；</li>
<li>一些初始化代码可能很复杂，不适宜在每份测试代码里都出现；</li>
<li>环境和测试业务可能分属业务方，初始化代码需要修改时不方便直接修改其它业务方代码。</li>
</ol>
<p>因此，将这些环境初始化独立成通用逻辑是优化代码结构的一个选择。</p>
<h3 id="提取初始化-Rule"><a href="#提取初始化-Rule" class="headerlink" title="提取初始化 Rule"></a>提取初始化 Rule</h3><p>Junit 提供了 TestRule 接口，可以控制测试代码执行前、执行后运行特定的片段，适宜这种初始化场景，那么我们将这个初始化抽成一个 Rule：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InitRule</span> : <span class="type">TestRule &#123;</span></span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">apply</span><span class="params">(base: <span class="type">Statement</span>?, description: <span class="type">Description</span>?)</span></span>: Statement &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">object</span> : Statement() &#123;</span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">evaluate</span><span class="params">()</span></span> &#123;</span><br><span class="line">                print(<span class="string">&quot;Init to 10&quot;</span>)</span><br><span class="line">                InitData.<span class="keyword">init</span>(<span class="number">10</span>)</span><br><span class="line">                base?.evaluate()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么测试代码就可以相应变成：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(AndroidJUnit4::class)</span></span><br><span class="line"><span class="meta">@Config(sdk = [26])</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RuleTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Rule</span></span><br><span class="line">    <span class="meta">@JvmField</span></span><br><span class="line">    <span class="keyword">val</span> initRule = RuleChain.outerRule(InitRule())</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">testInit</span><span class="params">()</span></span> &#123;</span><br><span class="line">        assertEquals(<span class="number">10</span>, InitData.getData())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="使用-Powermock"><a href="#使用-Powermock" class="headerlink" title="使用 Powermock"></a>使用 Powermock</h3><p>在我们的项目中，经常用到了 Powermock 来对依赖项进行 mock 操作。大家都知道，Powermock 是使用定制的 Classloader 加载测试类，达到替换被依赖类的目的。那么在与 Rule 的配合使用中就出现了问题：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(AndroidJUnit4::class)</span></span><br><span class="line"><span class="meta">@Config(sdk = [26])</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RuleTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Rule</span></span><br><span class="line">    <span class="meta">@JvmField</span></span><br><span class="line">    <span class="keyword">val</span> powerMockRule = PowerMockRule()</span><br><span class="line">    <span class="meta">@Rule</span></span><br><span class="line">    <span class="meta">@JvmField</span></span><br><span class="line">    <span class="keyword">val</span> initRule = RuleChain.outerRule(InitRule())</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">testInit</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// Test should fail here because initData has not been inited</span></span><br><span class="line">        assertEquals(<span class="number">10</span>, InitData.getData())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InitRule</span> : <span class="type">TestRule &#123;</span></span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">apply</span><span class="params">(base: <span class="type">Statement</span>?, description: <span class="type">Description</span>?)</span></span>: Statement &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">object</span> : Statement() &#123;</span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">evaluate</span><span class="params">()</span></span> &#123;</span><br><span class="line">                print(<span class="string">&quot;Init to 10&quot;</span>)</span><br><span class="line">                InitData.<span class="keyword">init</span>(<span class="number">10</span>)</span><br><span class="line">                base?.evaluate()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在运行这个测试时，将会失败：</p>
<blockquote>
<p>Init to 10<br>java.lang.AssertionError:<br>Expected :10<br>Actual   :0</p>
</blockquote>
<h2 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h2><p>根据输出，明明已经调用了初始化了，为什么在测试方法内还会说 <code>initData</code> 是默认值0呢？首先根据断点大法，看看测试执行过程中发生了什么。</p>
<h3 id="Rule-的执行顺序"><a href="#Rule-的执行顺序" class="headerlink" title="Rule 的执行顺序"></a>Rule 的执行顺序</h3><p>在各处打上断点之后，会发现自定义的 <code>InitRule</code> 先被执行，再执行 <code>PowerMockRule</code>。似乎 Rule 的执行顺序对测试结果有影响。先查看 JUnit 里的 <a target="_blank" rel="noopener" href="https://junit.org/junit4/javadoc/4.12/org/junit/Rule.html"><code>Rule</code>文档</a> 对于顺序的描述：</p>
<blockquote>
<p>However, if there are multiple fields (or methods) they will be applied in an order that depends on your JVM’s implementation of the reflection API, which is undefined, in general.</p>
</blockquote>
<p>JUnit 本身不保证 Rule 的执行顺序，那么先关注一下 <code>PowerMockRule</code> 内部进行了什么操作。</p>
<h3 id="PowerMockRule-做了什么"><a href="#PowerMockRule-做了什么" class="headerlink" title="PowerMockRule 做了什么"></a>PowerMockRule 做了什么</h3><p>先从表象上看，可以观察到一个现象： <code>InitRule</code> 执行时引用到了 <code>InitData</code> 类，那么其单例对象在类加载时就会被创建好，拥有一个内存地址，可以在 IDE 的 debug 模式中被看到；</p>
<p>继续运行，在测试方法体被执行时再次观察，会发现 <code>InitData</code> 的单例对象地址发生了改变，成为了一个新的对象，在没有其它调用初始化的地方时，其中存着的值当然就是默认值 0 了。</p>
<p>那么，在运行过程中，单例对象为什么会被替换呢？</p>
<p>从<a href="#%E4%BD%BF%E7%94%A8-powermock">上文提到的</a> Powermock 的原理中其实能有一个猜测：因为 Powermock 使用了自己定制的 Classloader ，那么会不会是因为新的 Classloader 加载了单例类之后生成了新的单例对象，并且在测试执行时使用了新对象导致的？</p>
<p>观察断点命中时的调用栈信息，我们能发现一点端倪：</p>
<p>在 AbstractClassloaderExecutor#executeWithClassLoader 中， Powermock 将测试类深度复制（deepclone）了一次，并且使用一个新的 classloader 去加载，然后才再执行测试代码。这个新的 classloader 是由 <code>PowerMockRule</code> 中返回的 <code>PowerMockStatement</code> 初始化的，由 <code>MockClassLoaderFactory</code> 生成的定制版，用处不言而喻当然是为了实现各种 mock 功能了。</p>
<p>由一个新的 classloader 加载测试类之后，其依赖的 <code>InitData</code> 类需要由相同的 classloader 加载，才能被正确使用。在重新加载的过程中生成了新的单例对象，其中的变量都保持着未初始化的状态。</p>
<p>由此可以扩展开来想，对于 <code>PowerMockRule</code> 这种需要更换 classloader 的环境操作，可以认为执行前和执行后是完全不相干的两套运行环境，切换环境前运行的所有初始化行为都不会对切换后的环境产生影响。因此我们定制的 <code>InitRule</code> 需要在 <code>PowerMockRule</code> 之后执行。</p>
<p>但是上文也提到了，对于 field 级的 Rule ，执行顺序是不被保证的，所幸 JUnit 提供了 <code>RuleChain</code> 来控制执行顺序。</p>
<h2 id="使用-RuleChain-再次优化"><a href="#使用-RuleChain-再次优化" class="headerlink" title="使用 RuleChain 再次优化"></a>使用 RuleChain 再次优化</h2><p>JUnit 提供了 <a target="_blank" rel="noopener" href="https://junit.org/junit4/javadoc/4.12/org/junit/rules/RuleChain.html"><code>RuleChain</code></a> 的方式来让我们手动地控制各种 <code>Rule</code> 的执行顺序。假设我们为测试类声明了这样一套 Rule：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Rule</span></span><br><span class="line"><span class="meta">@JvmField</span></span><br><span class="line"><span class="keyword">val</span> rule = RuleChain.outerRule(Rule1()).around(Rule2()).around(Rule3())</span><br></pre></td></tr></table></figure>

<p>那么，测试执行时将会严格按照 Rule1 -&gt; Rule2 -&gt; Rule3 的顺序进入，即执行各个 Rule 中 <code>base.evaluate()</code> 之前的语句，然后执行 <code>@Test</code> 测试方法，再按照 Rule3 -&gt; Rule2 -&gt; Rule1 的顺序退出，即执行 <code>base.evaluate()</code> 之后的语句。</p>
<p>但是，<code>RuleChain</code> 所接受的 Rule 需要是 <code>TestRule</code> 的子类，而 <code>PowerMockRule</code> 所使用的是即将要被废弃的 <code>MethodRule</code> ，并不兼容，需要进行一个适配转换的操作。</p>
<h3 id="使用-Adapter"><a href="#使用-Adapter" class="headerlink" title="使用 Adapter"></a>使用 Adapter</h3><p>除了等待 <code>PowerMockRule</code> 被正式升级为 <code>TestRule</code> 之外，可以使用其 <a target="_blank" rel="noopener" href="https://github.com/powermock/powermock/issues/396">issue 列表</a> 中提供的一个适配器，将 <code>MethodRule</code> 转换为 <code>TestRule</code> 实现：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestRuleAdapter</span></span>(<span class="keyword">private</span> <span class="keyword">val</span> rule: MethodRule) : TestRule &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">apply</span><span class="params">(base: <span class="type">Statement</span>, description: <span class="type">Description</span>)</span></span>: Statement &#123;</span><br><span class="line">        <span class="keyword">return</span> rule.apply(base, createFrameworkMethod(description), getTestObject(description))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">createFrameworkMethod</span><span class="params">(description: <span class="type">Description</span>)</span></span>: FrameworkMethod &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">val</span> methodName = description.methodName</span><br><span class="line">            <span class="keyword">val</span> c = getTestClass(description)</span><br><span class="line">            <span class="keyword">val</span> m = c.getDeclaredMethod(methodName)</span><br><span class="line">            <span class="keyword">return</span> FrameworkMethod(m)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">            <span class="keyword">throw</span> IllegalStateException(e)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getTestClass</span><span class="params">(description: <span class="type">Description</span>)</span></span>: Class&lt;*&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> description.testClass</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getTestObject</span><span class="params">(description: <span class="type">Description</span>)</span></span>: Any &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> getTestClass(description).newInstance()</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: InstantiationException) &#123;</span><br><span class="line">            <span class="keyword">throw</span> IllegalStateException(e)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: IllegalAccessException) &#123;</span><br><span class="line">            <span class="keyword">throw</span> IllegalStateException(e)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后我们就可以优雅地使用 <code>RuleChain</code> 管理我们的测试 Rule 了：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AdapterRuleTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Rule</span></span><br><span class="line">    <span class="meta">@JvmField</span></span><br><span class="line">    <span class="keyword">val</span> initRule = RuleChain.outerRule(TestRuleAdapter(PowerMockRule())).around(InitRule())</span><br><span class="line">    <span class="meta">@Mock</span></span><br><span class="line">    <span class="keyword">lateinit</span> <span class="keyword">var</span> mock: MockInterface</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">        MockitoAnnotations.initMocks(<span class="keyword">this</span>)</span><br><span class="line">        `<span class="keyword">when</span>`(mock.makeInt()).thenReturn(<span class="number">100</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">testInit</span><span class="params">()</span></span> &#123;</span><br><span class="line">        assertEquals(<span class="number">10</span>, InitData.getData())</span><br><span class="line"></span><br><span class="line">        <span class="comment">//make sure powermock is working now</span></span><br><span class="line">        assertEquals(<span class="number">100</span>, mock.makeInt())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">MockInterface</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">makeInt</span><span class="params">()</span></span>: <span class="built_in">Int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="还有一个执行位置"><a href="#还有一个执行位置" class="headerlink" title="还有一个执行位置"></a>还有一个执行位置</h2><p>除了使用 <code>Rule</code> <code>@Before</code> 初始化之外，JUnit 还提供了 <code>@BeforeClass</code> 这么一个注解来执行一些操作，我们来试试能不能使用：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(AndroidJUnit4::class)</span></span><br><span class="line"><span class="meta">@Config(sdk = [26])</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BeforeClassTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Rule</span></span><br><span class="line">    <span class="meta">@JvmField</span></span><br><span class="line">    <span class="keyword">val</span> powerMockRule = PowerMockRule()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="meta">@BeforeClass</span></span><br><span class="line">        <span class="meta">@JvmStatic</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">            InitData.<span class="keyword">init</span>(<span class="number">10</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">testInit</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// Test should fail here because initData has not been inited</span></span><br><span class="line">        assertEquals(<span class="number">10</span>, InitData.getData())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同样的，我们会得到一个断言错误：</p>
<blockquote>
<p>java.lang.AssertionError:<br>Expected :10<br>Actual   :0</p>
</blockquote>
<p>可以得出结论， <code>@BeforeClass</code> 是在 Rule 之前被执行的。</p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>使用一个 Adapter 将 PowerMockRule 包装成 TestRule 之后，就能使用 RuleChain 完整地控制 Rule 执行顺序了，这样就可以简单地用上其他人包装好的 Rule ，简化自己的测试代码。</p>
<p>文中所写的示例代码已经上传到了<a target="_blank" rel="noopener" href="https://github.com/xiaozhikang0916/TestRuleSample">我的 Github 仓库</a>中，执行 <code>test</code> 将会在上文提到的错误使用的位置断言失败。</p>
<p>但是，这个 Adapter 只能使用在普通的测试中，<a target="_blank" rel="noopener" href="https://github.com/junit-team/junit4/wiki/Parameterized-tests">参数化测试</a>不能使用，需要后续再扩展。</p>
</div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css"><p><span>本文标题：</span>Android 使用Powermock的单元测试的 Rule 顺序</p><p><span>文章作者：</span>Xiao</p><p><span>发布时间：</span>2019-12-10</p><p><span>最后更新：</span>2023-01-17</p><p><span>原始链接：</span><a href="/blog/android-test-rule-order/">https://blog.xiaozk.site/blog/android-test-rule-order/</a><span class="copy-path"><i class="fa fa-clipboard" data-clipboard-text="https://blog.xiaozk.site/blog/android-test-rule-order/"></i></span></p><p><span>版权声明：</span><a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/">本文采用<a rel="license noopener" target="_blank" href="http://creativecommons.org/licenses/by-nc/4.0/">知识共享署名-非商业性使用 4.0 国际许可协议（CC-BY-NC-4.0）</a>进行许可。</a></p></div><br><div class="tags"><a href="/tags/Android/"><i class="fa fa-tag"></i>Android</a><a href="/tags/Unittest/"><i class="fa fa-tag"></i>Unittest</a><a href="/tags/Powermock/"><i class="fa fa-tag"></i>Powermock</a><a href="/tags/mock-rule/"><i class="fa fa-tag"></i>mock rule</a><a href="/tags/RuleChain/"><i class="fa fa-tag"></i>RuleChain</a></div><div class="post-nav"><a class="pre" href="/blog/java-override-constructor/">java 构造方法的重载</a><a class="next" href="/blog/item-touch-helper-section/">ItemTouchHelper实现拖动分组与定制</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://blog.xiaozk.site"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/RecyclerView/" style="font-size: 15px;">RecyclerView</a> <a href="/tags/Callback/" style="font-size: 15px;">Callback</a> <a href="/tags/kotlin/" style="font-size: 15px;">kotlin</a> <a href="/tags/forEach/" style="font-size: 15px;">forEach</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/stream/" style="font-size: 15px;">stream</a> <a href="/tags/ItemTouchHelper/" style="font-size: 15px;">ItemTouchHelper</a> <a href="/tags/Unittest/" style="font-size: 15px;">Unittest</a> <a href="/tags/Powermock/" style="font-size: 15px;">Powermock</a> <a href="/tags/mock-rule/" style="font-size: 15px;">mock rule</a> <a href="/tags/RuleChain/" style="font-size: 15px;">RuleChain</a> <a href="/tags/Java/" style="font-size: 15px;">Java</a> <a href="/tags/Constructor/" style="font-size: 15px;">Constructor</a> <a href="/tags/MVVM/" style="font-size: 15px;">MVVM</a> <a href="/tags/lambda/" style="font-size: 15px;">lambda</a> <a href="/tags/xml/" style="font-size: 15px;">xml</a> <a href="/tags/layout/" style="font-size: 15px;">layout</a> <a href="/tags/drawable/" style="font-size: 15px;">drawable</a> <a href="/tags/color/" style="font-size: 15px;">color</a> <a href="/tags/selector/" style="font-size: 15px;">selector</a> <a href="/tags/ItemAnimator/" style="font-size: 15px;">ItemAnimator</a> <a href="/tags/coroutine/" style="font-size: 15px;">coroutine</a> <a href="/tags/%E5%AE%89%E5%8D%93/" style="font-size: 15px;">安卓</a> <a href="/tags/%E5%8D%8F%E7%A8%8B/" style="font-size: 15px;">协程</a> <a href="/tags/RenderNode/" style="font-size: 15px;">RenderNode</a> <a href="/tags/Canvas/" style="font-size: 15px;">Canvas</a> <a href="/tags/ItemDecoration/" style="font-size: 15px;">ItemDecoration</a> <a href="/tags/Animation/" style="font-size: 15px;">Animation</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/blog/android-render-node/">在 Android 中使用 Render Node 加速渲染</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/coroutine-task/">使用协程组合管理业务逻辑</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/recycler-animate-decoration/">RecyclerView 中为 ItemDecoration 应用动画</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/recycler-animator-click/">RecyclerView 的 item 在动画过程中的点击事件</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/android-drawable-color-selector/">Android xml 中 drawable、color 的混用与 selector</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/kotlin-lambda-param/">kotlin 中传入形参、返回不匹配的 lambda 表达式</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/thoughts-of-android-mvvm/">Android 项目中使用 MVVM 模式的一些思考</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/java-override-constructor/">java 构造方法的重载</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/android-test-rule-order/">Android 使用Powermock的单元测试的 Rule 顺序</a></li><li class="post-list-item"><a class="post-list-link" href="/blog/item-touch-helper-section/">ItemTouchHelper实现拖动分组与定制</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2023 <a href="/." rel="nofollow">Xiao's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>